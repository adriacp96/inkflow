<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 15px;
      line-height: 1.4;
    }
    h1, h2 {
      font-family: sans-serif;
      text-transform: uppercase;
      border-bottom: 2px solid #000;
      padding-bottom: 4px;
    }
    h1 { font-size: 1.3rem; }
    h2 { font-size: 1rem; margin-top: 25px; }

    .section { margin-bottom: 20px; }

    label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; }
    input, select, button {
      width: 100%;
      padding: 10px;
      border: 2px solid #000;
      border-radius: 0;
      font-size: 1rem;
      background: #fff;
      margin-bottom: 10px;
    }
    button {
      background: #000;
      color: #fff;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
    }
    button.alt { background: #fff; color: #000; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .chart-row { margin: 12px 0; }
    .bar-bg { border: 1px solid #000; height: 20px; width: 100%; }
    .bar-fill { background: #000; height: 100%; }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.9rem; }

    .card-item { border-bottom: 1px solid #000; padding: 10px 0; }

    table { width: 100%; border-collapse: collapse; }
    th { font-size: 0.75rem; border-bottom: 1px solid #000; }
    td { padding: 6px 0; border-bottom: 1px dotted #000; }
    .right { text-align: right; }

    .status-msg { font-size: 0.8rem; font-style: italic; }

    .mini { font-size: 0.8rem; opacity: 0.9; }
  </style>
</head>
<body>

<h1>Finanzas</h1>

<div class="section">
  <div class="grid">
    <div>
      <label>PIN ACCESO</label>
      <input id="pinInput" type="password" placeholder="******" />
    </div>
    <div>
      <label>&nbsp;</label>
      <button class="alt" id="savePin">OK</button>
    </div>
  </div>
  <div id="pinHint" class="status-msg"></div>
</div>

<div class="section">
  <label>PERIODO</label>
  <div class="grid">
    <select id="monthSelect"></select>
    <select id="yearSelect"></select>
  </div>
  <div id="status" class="status-msg"></div>
</div>

<div class="section">
  <h2>Resumen de Gastos</h2>
  <div id="chartsContainer"><p style="font-size:0.8rem">Cargando…</p></div>
</div>

<div class="section">
  <h2>Tarjetas del Mes</h2>
  <div id="cardsForm"></div>
  <button id="syncNow">GUARDAR Y SINCRONIZAR</button>
  <button class="alt" id="resetCards">LIMPIAR DATOS</button>
</div>

<div class="section">
  <h2>Gastos Fijos (Prorrateo Mensual)</h2>
  <table>
    <thead>
      <tr>
        <th>CONCEPTO</th>
        <th class="right">REAL MENSUAL</th>
      </tr>
    </thead>
    <tbody id="fixedTableBody"></tbody>
  </table>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://wogqftmhwgosoaldwees.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvZ3FmdG1od2dvc29hbGR3ZWVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODE2MjUsImV4cCI6MjA4NTE1NzYyNX0.lJw1YPSOiV-RJBrhX7aNpJiwUwGjes6cNxTfg5CEg38";
const PIN_KEY = "fin_pin_v1";

/* ================= DATOS ================= */
const FIXED = [
  { concept:"Apple One", freq:"Mensual", amount:97.95, currency:"AED" },
  { concept:"Netflix", freq:"Mensual", amount:9.99, currency:"EUR" },
  { concept:"Real Debrid", freq:"Semestral", amount:16, currency:"EUR" },
  { concept:"Formula 1", freq:"Anual", amount:3649, currency:"IDR" },
  { concept:"YouTube Premium", freq:"Mensual", amount:195, currency:"IDR" },
  { concept:"Du", freq:"Mensual", amount:252, currency:"AED" },
  { concept:"Virgin", freq:"Anual", amount:1575, currency:"AED" },
  { concept:"Emirates Islamic", freq:"Mensual", amount:1739, currency:"AED" },
  { concept:"Emirates NBD", freq:"Mensual", amount:3346, currency:"AED" },
  { concept:"Seguro coche", freq:"Anual", amount:3003, currency:"AED" },
  { concept:"Carné conducir", freq:"Trienal", amount:320, currency:"AED" }
];

const CARDS = [
  { name:"Emirates NBD", currency:"AED" },
  { name:"Tabby", currency:"AED" },
  { name:"Amex", currency:"EUR" }
];

/* ================= UTIL ================= */
function monthlyReal(f){
  if(f.freq==="Mensual") return f.amount;
  if(f.freq==="Anual") return f.amount/12;
  if(f.freq==="Semestral") return f.amount/6;
  if(f.freq==="Trienal") return f.amount/36;
  return 0;
}
function setStatus(t){ document.getElementById("status").textContent = t; }

function ensurePin(){
  const p = (localStorage.getItem(PIN_KEY)||"").trim();
  if(!p || p.length<6) throw new Error("PIN inválido.");
  return p;
}

function currentMonthISO(){
  const m = document.getElementById("monthSelect").value;
  const y = document.getElementById("yearSelect").value;
  return `${y}-${m}`;
}

function functionUrl(){
  return `${SUPABASE_URL}/functions/v1/finanzas`;
}

async function apiCall(action, month, data=null){
  const pin = ensurePin();
  const res = await fetch(functionUrl(),{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${SUPABASE_ANON_KEY}`,
      "apikey":SUPABASE_ANON_KEY
    },
    body:JSON.stringify({action,pin,month,data})
  });
  const j = await res.json();
  if(!res.ok) throw new Error(j.error||"Error");
  return j;
}

/* ================= RENDER ================= */
function renderCards(cards){
  const w = document.getElementById("cardsForm");
  w.innerHTML="";

  CARDS.forEach(c=>{
    const total = (cards?.[c.name]?.amount ?? "");
    const minPay = (cards?.[c.name]?.min_payment ?? ""); // NUEVO
    const paid = !!cards?.[c.name]?.paid;

    w.innerHTML+=`
      <div class="card-item">
        <label>${c.name} (${c.currency})</label>

        <div class="grid">
          <div>
            <div class="mini"><strong>Deuda total</strong></div>
            <input type="number" step="0.01" data-card-total="${c.name}" value="${total}">
          </div>
          <div>
            <div class="mini"><strong>Mínimo a pagar este mes</strong></div>
            <input type="number" step="0.01" data-card-min="${c.name}" value="${minPay}">
          </div>
        </div>

        <div class="grid">
          <div></div>
          <div>
            <div class="mini"><strong>Estado</strong></div>
            <select data-paid="${c.name}">
              <option value="no" ${!paid?"selected":""}>Pendiente</option>
              <option value="si" ${paid?"selected":""}>Pagado</option>
            </select>
          </div>
        </div>
      </div>`;
  });
}

function renderCharts(cards){
  const c=document.getElementById("chartsContainer");
  c.innerHTML="";

  // Dos barras por moneda:
  // - TOTAL (fijos + deuda total tarjetas)
  // - A PAGAR (fijos + mínimo tarjetas)
  ["AED","EUR","IDR"].forEach(cur=>{
    let fixed=0; FIXED.filter(x=>x.currency===cur).forEach(x=>fixed+=monthlyReal(x));

    let cardTotal=0;
    let cardMin=0;

    CARDS.filter(x=>x.currency===cur).forEach(x=>{
      cardTotal += Number(cards?.[x.name]?.amount || 0);
      cardMin   += Number(cards?.[x.name]?.min_payment || 0);
    });

    const total = fixed + cardTotal;
    const pay   = fixed + cardMin;

    if (!total && !pay) return;

    const maxVal = cur === "IDR" ? 10000 : 8000;
    const pctTotal = Math.min((total / maxVal) * 100, 100);
    const pctPay   = Math.min((pay   / maxVal) * 100, 100);

    c.innerHTML += `
      <div class="chart-row">
        <div class="bar-label">
          <span><strong>${cur}</strong> (TOTAL)</span>
          <span>${total.toFixed(2)}</span>
        </div>
        <div class="bar-bg"><div class="bar-fill" style="width:${pctTotal}%"></div></div>
      </div>

      <div class="chart-row">
        <div class="bar-label">
          <span><strong>${cur}</strong> (A PAGAR)</span>
          <span>${pay.toFixed(2)}</span>
        </div>
        <div class="bar-bg"><div class="bar-fill" style="width:${pctPay}%"></div></div>
      </div>
    `;
  });

  if(!c.innerHTML.trim()){
    c.innerHTML = `<p style="font-size:0.8rem">Sin datos para este mes.</p>`;
  }
}

function renderFixed(){
  const tb=document.getElementById("fixedTableBody");
  tb.innerHTML="";
  FIXED.forEach(f=>{
    const m=monthlyReal(f);
    tb.innerHTML+=`<tr><td>${f.concept}</td><td class="right">${f.currency} ${m.toFixed(2)}</td></tr>`;
  });
}

function collectCards(){
  const o={};

  // Total deuda
  document.querySelectorAll("input[data-card-total]").forEach(i=>{
    const name = i.dataset.cardTotal;
    o[name] = o[name] || {};
    o[name].amount = Number(i.value) || 0;
  });

  // Min payment
  document.querySelectorAll("input[data-card-min]").forEach(i=>{
    const name = i.dataset.cardMin;
    o[name] = o[name] || {};
    o[name].min_payment = Number(i.value) || 0;
  });

  // Paid flag
  document.querySelectorAll("select[data-paid]").forEach(s=>{
    const name = s.dataset.paid;
    o[name] = o[name] || {};
    o[name].paid = (s.value === "si");
  });

  return o;
}

/* ================= AUTO LOAD ================= */
async function autoLoad(){
  try{
    const m=currentMonthISO();
    setStatus("Cargando…");
    const r=await apiCall("get",m);
    const d=r.data||{cards:{}};

    renderCards(d.cards);
    renderCharts(d.cards);

    setStatus("Actualizado ✅");
  }catch(e){
    renderCards({});
    renderCharts({});
    setStatus(e.message);
  }
}

/* ================= INIT ================= */
(function(){
  const now=new Date();
  const ms=document.getElementById("monthSelect");
  const ys=document.getElementById("yearSelect");

  ["01","02","03","04","05","06","07","08","09","10","11","12"]
    .forEach((m,i)=>ms.innerHTML+=`<option value="${m}">${i+1}</option>`);

  const y=now.getFullYear();
  for(let i=y-2;i<=y+2;i++) ys.innerHTML+=`<option value="${i}">${i}</option>`;

  ms.value=String(now.getMonth()+1).padStart(2,"0");
  ys.value=y;

  renderFixed();
  renderCards({});
  renderCharts({});

  const p=localStorage.getItem(PIN_KEY);
  document.getElementById("pinHint").textContent=p?"PIN guardado ✅":"Introduce el PIN";
  if(p) autoLoad();
  else setStatus("Introduce el PIN y pulsa OK.");
})();

document.getElementById("savePin").onclick=()=>{
  const p=document.getElementById("pinInput").value.trim();
  if(p.length<6) return setStatus("PIN inválido");
  localStorage.setItem(PIN_KEY,p);
  document.getElementById("pinInput").value="";
  document.getElementById("pinHint").textContent="PIN guardado ✅";
  autoLoad();
};

document.getElementById("monthSelect").onchange=autoLoad;
document.getElementById("yearSelect").onchange=autoLoad;

document.getElementById("syncNow").onclick=async()=>{
  try{
    const m=currentMonthISO();
    setStatus("Sincronizando…");

    const cards=collectCards();
    await apiCall("set",m,{month:m,cards});

    await autoLoad();
    setStatus("Sincronizado ✅");
  }catch(e){ setStatus(e.message); }
};

document.getElementById("resetCards").onclick=()=>{
  renderCards({});
  renderCharts({});
  setStatus("Limpio");
};
</script>
</body>
</html>
