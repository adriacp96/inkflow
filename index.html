<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas E-Ink</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: serif; 
      background: #fff; 
      color: #000; 
      margin: 0; 
      padding: 15px;
      line-height: 1.4;
    }
    h1, h2 { font-family: sans-serif; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 4px; }
    h1 { font-size: 1.3rem; margin-top: 0; }
    h2 { font-size: 1rem; margin-top: 25px; }

    .section { margin-bottom: 20px; }
    
    label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
    select, input, button { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #000; 
      border-radius: 0; 
      font-size: 1rem;
      background: #fff;
      margin-bottom: 10px;
      color: #000;
      -webkit-appearance: none; /* Elimina sombras en iOS */
    }
    button { background: #000; color: #fff; font-weight: bold; cursor: pointer; }
    button.alt { background: #fff; color: #000; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    /* Gráfico */
    .chart-row { margin: 12px 0; }
    .bar-bg { border: 1px solid #000; height: 18px; width: 100%; background: #fff; margin-top: 4px; }
    .bar-fill { background: #000; height: 100%; width: 0%; }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.9rem; font-family: sans-serif; }

    .card-item { border-bottom: 1px solid #000; padding: 12px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; font-size: 0.75rem; border-bottom: 1px solid #000; padding-bottom: 5px; }
    td { padding: 8px 0; font-size: 0.9rem; border-bottom: 1px dotted #000; }
    .right { text-align: right; }
    
    .status-msg { font-size: 0.8rem; margin-top: 5px; font-style: italic; border-left: 3px solid #000; padding-left: 8px; }
  </style>
</head>
<body>

  <h1>Finanzas</h1>

  <div class="section">
    <div class="grid">
      <div>
        <label>PIN Acceso</label>
        <input id="pinInput" type="password" placeholder="******" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="alt" id="savePin">Guardar</button>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="grid-3">
      <div>
        <label>Año</label>
        <select id="yearSelect"></select>
      </div>
      <div>
        <label>Mes</label>
        <select id="monthSelect">
          <option value="01">Enero</option>
          <option value="02">Febrero</option>
          <option value="03">Marzo</option>
          <option value="04">Abril</option>
          <option value="05">Mayo</option>
          <option value="06">Junio</option>
          <option value="07">Julio</option>
          <option value="08">Agosto</option>
          <option value="09">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadMonth">Ir</button>
      </div>
    </div>
    <div id="status" class="status-msg">Selecciona y pulsa 'Ir'.</div>
  </div>

  <div class="section">
    <h2>Resumen de Gastos</h2>
    <div id="chartsContainer"></div>
  </div>

  <div class="section">
    <h2>Tarjetas</h2>
    <div id="cardsForm"></div>
    <button id="saveCards">Guardar en Nube</button>
  </div>

  <div class="section">
    <h2>Gastos Fijos</h2>
    <table>
      <thead>
        <tr>
          <th>CONCEPTO</th>
          <th class="right">MENSUAL</th>
        </tr>
      </thead>
      <tbody id="fixedTableBody"></tbody>
    </table>
  </div>

<script>
// Configuración y Datos
const SUPABASE_URL = "https://wogqftmhwgosoaldwees.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvZ3FmdG1od2dvc29hbGR3ZWVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODE2MjUsImV4cCI6MjA4NTE1NzYyNX0.lJw1YPSOiV-RJBrhX7aNpJiwUwGjes6cNxTfg5CEg38";

const FIXED = [
  { concept:"Apple One", freq:"Mensual", amount:97.95, currency:"AED" },
  { concept:"Netflix", freq:"Mensual", amount:9.99, currency:"EUR" },
  { concept:"Real Debrid", freq:"Semestral", amount:16, currency:"EUR" },
  { concept:"Formula 1", freq:"Anual", amount:3649, currency:"IDR" },
  { concept:"YouTube Premium", freq:"Mensual", amount:195, currency:"IDR" },
  { concept:"Du", freq:"Mensual", amount:252, currency:"AED" },
  { concept:"Virgin", freq:"Anual", amount:1575, currency:"AED" },
  { concept:"Emirates Islamic", freq:"Mensual", amount:1739, currency:"AED" },
  { concept:"Emirates NBD", freq:"Mensual", amount:3346, currency:"AED" },
  { concept:"Seguro coche", freq:"Anual", amount:3003, currency:"AED" },
  { concept:"Carné conducir", freq:"Trienal", amount:320, currency:"AED" }
];

const CARDS = [
  { name:"Emirates NBD", currency:"AED" },
  { name:"Tabby", currency:"AED" },
  { name:"Amex", currency:"EUR" }
];

// Auxiliares
function monthlyReal(f){
  if(f.freq === "Mensual") return f.amount;
  if(f.freq === "Anual") return f.amount/12;
  if(f.freq === "Semestral") return f.amount/6;
  if(f.freq === "Trienal") return f.amount/36;
  return 0;
}

// Inicializar Selectores de Fecha
function initDateSelectors() {
  const yearSel = document.getElementById("yearSelect");
  const monthSel = document.getElementById("monthSelect");
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = String(now.getMonth() + 1).padStart(2, '0');

  // Llenar años (Rango 2024 - 2030)
  for (let y = 2024; y <= 2030; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    if(y === currentYear) opt.selected = true;
    yearSel.appendChild(opt);
  }

  // Seleccionar mes actual
  monthSel.value = currentMonth;
}

// Renderizados
function renderCharts(cardsData) {
  const container = document.getElementById("chartsContainer");
  container.innerHTML = "";
  const currs = ["AED", "EUR", "IDR"];

  currs.forEach(cur => {
    let fixed = FIXED.filter(f => f.currency === cur).reduce((acc, f) => acc + monthlyReal(f), 0);
    let card = CARDS.filter(c => c.currency === cur).reduce((acc, c) => acc + Number(cardsData?.[c.name]?.amount || 0), 0);
    const total = fixed + card;
    if (total === 0) return;

    const maxVal = cur === "IDR" ? 10000 : 8000; 
    const percent = Math.min((total / maxVal) * 100, 100);

    container.innerHTML += `
      <div class="chart-row">
        <div class="bar-label"><span><strong>${cur}</strong></span><span>${total.toFixed(2)}</span></div>
        <div class="bar-bg"><div class="bar-fill" style="width:${percent}%"></div></div>
      </div>`;
  });
}

function renderCards(data) {
  const wrap = document.getElementById("cardsForm");
  wrap.innerHTML = "";
  CARDS.forEach(c => {
    const val = data?.[c.name]?.amount;
    const amount = val ? Number(val).toFixed(2) : "";
    const isPaid = data?.[c.name]?.paid;
    wrap.innerHTML += `
      <div class="card-item">
        <label>${c.name} (${c.currency})</label>
        <div class="grid">
          <input type="number" step="0.01" data-card="${c.name}" value="${amount}" placeholder="0.00" />
          <select data-paid="${c.name}">
            <option value="no" ${!isPaid?'selected':''}>Pendiente</option>
            <option value="si" ${isPaid?'selected':''}>Pagado</option>
          </select>
        </div>
      </div>`;
  });
}

function renderFixed() {
  const tbody = document.getElementById("fixedTableBody");
  tbody.innerHTML = "";
  FIXED.forEach(f => {
    tbody.innerHTML += `<tr><td>${f.concept}</td><td class="right">${f.currency} ${monthlyReal(f).toFixed(2)}</td></tr>`;
  });
}

// Eventos
document.getElementById("loadMonth").addEventListener("click", () => {
  const m = document.getElementById("monthSelect").value;
  const y = document.getElementById("yearSelect").value;
  document.getElementById("status").textContent = `Cargando ${m}/${y}...`;
  // Aquí llamarías a apiCall("get", `${y}-${m}`)
});

document.getElementById("saveCards").addEventListener("click", () => {
  const cards = {};
  document.querySelectorAll("input[data-card]").forEach(i => {
    cards[i.dataset.card] = { amount: parseFloat(i.value) || 0 };
  });
  renderCharts(cards);
  document.getElementById("status").textContent = "Cambios listos para guardar.";
});

// Inicio
initDateSelectors();
renderFixed();
renderCards({});
renderCharts({});
</script>
</body>
</html>
