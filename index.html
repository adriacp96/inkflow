<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:16px; background:#fff; color:#000; }
    h1 { margin:0 0 12px; font-size:18px; text-transform:uppercase; border-bottom:2px solid #000; padding-bottom:6px; }
    .section { border:2px solid #000; padding:12px; margin:12px 0; }
    label { display:block; font-size:12px; font-weight:800; text-transform:uppercase; margin-bottom:6px; }
    input, button { width:100%; padding:10px; border:2px solid #000; border-radius:0; font-size:14px; background:#fff; margin-bottom:10px; }
    button { background:#000; color:#fff; font-weight:900; text-transform:uppercase; cursor:pointer; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .status { font-size:12px; font-style:italic; min-height:16px; }
    .hidden { display:none !important; }
    pre { margin:0; border:2px solid #000; padding:10px; font-size:12px; min-height:180px; white-space:pre-wrap; word-break:break-word; }
  </style>
</head>
<body>

<h1>Finanzas</h1>

<div class="section">
  <div class="grid">
    <div>
      <label>PIN</label>
      <input id="pinInput" type="password" placeholder="******" />
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="pinOk">OK</button>
    </div>
  </div>
  <div id="pinStatus" class="status">Introduce el PIN.</div>
</div>

<!-- Solo se ve si el PIN es correcto -->
<div id="content" class="section hidden">
  <label>Respuesta del backend</label>
  <pre id="out">{}</pre>
  <button id="lock" style="background:#fff;color:#000;">BLOQUEAR</button>
</div>

<script>
const SUPABASE_URL = "https://jwssqrtbsmrjrnerpunt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3c3NxcnRic21yanJuZXJwdW50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODM4NzYsImV4cCI6MjA4NTE1OTg3Nn0.Rl_kRUUTgYt763PakOlBvRObvergx_QBU37aEpAEvlQ";

let SESSION_PIN = "";

function setStatus(t){ document.getElementById("pinStatus").textContent = t; }
function showData(obj){
  document.getElementById("out").textContent = JSON.stringify(obj, null, 2);
}
function lock(){
  SESSION_PIN = "";
  document.getElementById("content").classList.add("hidden");
  showData({});
  setStatus("Introduce el PIN.");
}
function unlock(){
  document.getElementById("content").classList.remove("hidden");
}

async function callFinanzas(action){
  const res = await fetch(`${SUPABASE_URL}/functions/v1/finanzas`, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "apikey": SUPABASE_ANON_KEY
    },
    body: JSON.stringify({ action, pin: SESSION_PIN })
  });

  const j = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(j.error || `HTTP ${res.status}`);
  return j.data;
}

document.getElementById("pinOk").addEventListener("click", async ()=>{
  lock();
  const p = document.getElementById("pinInput").value.trim();
  if(p.length < 6) return setStatus("PIN inválido (mínimo 6).");

  SESSION_PIN = p;
  setStatus("Verificando…");

  try{
    const data = await callFinanzas("get");
    unlock();
    showData(data);
    setStatus("PIN correcto ✅");
    document.getElementById("pinInput").value = "";
  }catch(e){
    lock();
    setStatus(e.message || "PIN incorrecto.");
  }
});

document.getElementById("lock").addEventListener("click", lock);
</script>

</body>
</html>
