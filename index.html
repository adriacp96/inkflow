<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: serif; background:#fff; color:#000; margin:0; padding:15px; line-height:1.4; }
    h1,h2 { font-family:sans-serif; text-transform:uppercase; border-bottom:2px solid #000; padding-bottom:4px; }
    h1{ font-size:1.3rem; } h2{ font-size:1rem; margin-top:25px; }
    .section{ margin-bottom:20px; }
    label{ display:block; font-size:.85rem; font-weight:bold; margin-bottom:5px; }
    input,select,button{ width:100%; padding:10px; border:2px solid #000; border-radius:0; font-size:1rem; background:#fff; margin-bottom:10px; }
    button{ background:#000; color:#fff; font-weight:bold; text-transform:uppercase; cursor:pointer; }
    button.alt{ background:#fff; color:#000; }
    button.danger{ background:#fff; color:#000; border-style:dashed; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .chart-row{ margin:12px 0; } .bar-bg{ border:1px solid #000; height:20px; width:100%; } .bar-fill{ background:#000; height:100%; }
    .bar-label{ display:flex; justify-content:space-between; font-size:.9rem; }
    .card-item{ border-bottom:1px solid #000; padding:10px 0; }
    table{ width:100%; border-collapse:collapse; }
    th{ font-size:.75rem; border-bottom:1px solid #000; text-transform:uppercase; }
    td{ padding:8px 0; border-bottom:1px dotted #000; vertical-align:top; }
    .right{ text-align:right; }
    .status-msg{ font-size:.8rem; font-style:italic; }
    .mini{ font-size:.8rem; opacity:.9; }
    .muted{ opacity:.8; font-size:.85rem; }
    .pill{ display:inline-block; border:1px solid #000; padding:2px 6px; font-size:.75rem; margin-right:6px; }
    .row-ok{ opacity:.65; text-decoration:line-through; }
    .row-head{ border-bottom:1px solid #000; padding:6px 0; margin-top:10px; }
    .small-btn{ padding:8px; font-size:.85rem; }
  </style>
</head>
<body>

<h1>Finanzas</h1>

<div class="section">
  <div class="grid">
    <div>
      <label>PIN ACCESO</label>
      <input id="pinInput" type="password" placeholder="******" />
    </div>
    <div>
      <label>&nbsp;</label>
      <button class="alt" id="savePin">OK</button>
    </div>
  </div>
  <div id="pinHint" class="status-msg"></div>
</div>

<div class="section">
  <label>PERIODO</label>
  <div class="grid">
    <select id="monthSelect"></select>
    <select id="yearSelect"></select>
  </div>
  <div id="status" class="status-msg"></div>
</div>

<div class="section">
  <h2>Calendario de pagos del mes</h2>
  <div class="muted">Pagados y fechas se guardan en Supabase.</div>
  <table>
    <thead>
      <tr>
        <th style="width:90px;">Fecha</th>
        <th>Concepto</th>
        <th class="right" style="width:140px;">Importe</th>
        <th class="right" style="width:90px;">Pagado</th>
      </tr>
    </thead>
    <tbody id="payTableBody"></tbody>
  </table>
</div>

<div class="section">
  <h2>Resumen de Gastos</h2>
  <div id="chartsContainer"><p style="font-size:0.8rem">Cargando…</p></div>
</div>

<div class="section">
  <h2>Tarjetas del Mes</h2>
  <div class="muted">Aquí solo cambian importes del mes (deuda total + mínimo). La “fecha de cobro” se configura abajo.</div>
  <div id="cardsForm"></div>
  <button id="syncNow">GUARDAR Y SINCRONIZAR</button>
</div>

<div class="section">
  <h2>Gestión de pagos recurrentes y tarjetas</h2>
  <div class="grid">
    <button class="alt" id="addFixed">AÑADIR PAGO RECURRENTE</button>
    <button class="alt" id="addCard">AÑADIR TARJETA</button>
  </div>
  <div id="itemsEditor"></div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://shutikbjqebnluifehix.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNodXRpa2JqcWVibmx1aWZlaGl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTY1MjEsImV4cCI6MjA4NTE3MjUyMX0.tFQms5ZBAz3OFau1dNEcFntO8gzXEV3OLIPUwf67XeE";
const PIN_KEY = "fin_pin_v1"; // solo para recordar el PIN (si quieres quitarlo, dilo y lo cambiamos)

let STATE = {
  month: null,
  items: [],    // fin_items
  cardsMonth: {}, // fin_month.cards
  paid: {},     // map item_id -> bool
};

/* ================= UTIL ================= */
function setStatus(t){ document.getElementById("status").textContent = t; }
function ensurePin(){
  const p=(localStorage.getItem(PIN_KEY)||"").trim();
  if(!p || p.length<6) throw new Error("PIN inválido.");
  return p;
}
function currentMonthISO(){
  const m=document.getElementById("monthSelect").value;
  const y=document.getElementById("yearSelect").value;
  return `${y}-${m}`;
}
function functionUrl(){ return `${SUPABASE_URL}/functions/v1/finanzas`; }

async function apiCall(action, month=null, data=null){
  const pin = ensurePin();
  const res = await fetch(functionUrl(),{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${SUPABASE_ANON_KEY}`,
      "apikey":SUPABASE_ANON_KEY
    },
    body:JSON.stringify({ action, pin, month, data })
  });
  const j = await res.json();
  if(!res.ok) throw new Error(j.error||"Error");
  return j.data;
}

function clampDay(y, mIndex, day){
  const last = new Date(y, mIndex+1, 0).getDate();
  return Math.min(Math.max(1, day), last);
}
function prettyDate(d){
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=String(d.getFullYear()).slice(-2);
  return `${dd}/${mm}/${yy}`;
}

/* ================= SCHEDULE ENGINE ================= */
function occursInMonth(item, ym){
  const [Y,M]=ym.split("-").map(Number);
  const mIndex=M-1;

  const st=item.schedule_type;

  if(st==="monthly"){
    const day = clampDay(Y, mIndex, Number(item.schedule_day)||1);
    return { occurs:true, date: new Date(Y, mIndex, day) };
  }

  const nextStr=item.schedule_next;
  const next = nextStr ? new Date(nextStr+"T00:00:00") : null;
  if(!next || isNaN(next)) return { occurs:false, date:null };

  let d = new Date(next.getTime());
  const start = new Date(Y, mIndex, 1);
  const end = new Date(Y, mIndex+1, 0, 23,59,59);

  let guard=0;
  while(d < start && guard++ < 5000){
    if(st==="every_n_months"){
      d.setMonth(d.getMonth() + (Number(item.schedule_interval_months)||1));
    } else if(st==="every_n_years"){
      d.setFullYear(d.getFullYear() + (Number(item.schedule_interval_years)||1));
    } else break;
  }

  if(d >= start && d <= end) return { occurs:true, date:d };
  return { occurs:false, date:null };
}

function monthlyReal(item){
  // prorrateo visual (no “calendario”)
  const st=item.schedule_type;
  const amt=Number(item.amount_default||0);
  if(st==="monthly") return amt;
  if(st==="every_n_months") return amt / (Number(item.schedule_interval_months)||1);
  if(st==="every_n_years") return amt / (12*(Number(item.schedule_interval_years)||1));
  return 0;
}

/* ================= RENDER: CARDS MONTH FORM =================
  Guardamos importes de tarjeta por item_id dentro de fin_month.cards:
    cards = { [item_id]: { amount, min_payment, paid_month?: bool } }
*/
function cardItems(){
  return STATE.items.filter(x=>x.type==="card" && x.active);
}

function renderCardsMonth(){
  const w=document.getElementById("cardsForm");
  w.innerHTML="";

  const cards = cardItems();
  if(!cards.length){
    w.innerHTML = `<p class="muted">No tienes tarjetas creadas. Usa “AÑADIR TARJETA”.</p>`;
    return;
  }

  cards.forEach(it=>{
    const v = STATE.cardsMonth?.[it.id] || {};
    const total = (v.amount ?? "");
    const minPay = (v.min_payment ?? "");
    const paid = !!v.paid;

    w.innerHTML += `
      <div class="card-item">
        <label>${it.name} (${it.currency})</label>

        <div class="grid">
          <div>
            <div class="mini"><strong>Deuda total</strong></div>
            <input type="number" step="0.01" data-card-total="${it.id}" value="${total}">
          </div>
          <div>
            <div class="mini"><strong>Mínimo a pagar este mes</strong></div>
            <input type="number" step="0.01" data-card-min="${it.id}" value="${minPay}">
          </div>
        </div>

        <div class="grid">
          <div></div>
          <div>
            <div class="mini"><strong>Estado</strong></div>
            <select data-card-paid="${it.id}">
              <option value="no" ${!paid?"selected":""}>Pendiente</option>
              <option value="si" ${paid?"selected":""}>Pagado</option>
            </select>
          </div>
        </div>
      </div>
    `;
  });
}

function collectCardsMonth(){
  const out = structuredClone(STATE.cardsMonth || {});
  document.querySelectorAll("input[data-card-total]").forEach(i=>{
    const id=i.dataset.cardTotal;
    out[id]=out[id]||{};
    out[id].amount = Number(i.value)||0;
  });
  document.querySelectorAll("input[data-card-min]").forEach(i=>{
    const id=i.dataset.cardMin;
    out[id]=out[id]||{};
    out[id].min_payment = Number(i.value)||0;
  });
  document.querySelectorAll("select[data-card-paid]").forEach(s=>{
    const id=s.dataset.cardPaid;
    out[id]=out[id]||{};
    out[id].paid = (s.value==="si");
  });
  return out;
}

/* ================= RENDER: CHARTS ================= */
function renderCharts(){
  const c=document.getElementById("chartsContainer");
  c.innerHTML="";

  ["AED","EUR","IDR"].forEach(cur=>{
    let fixedSum=0;
    STATE.items.filter(x=>x.active && x.type==="fixed" && x.currency===cur)
      .forEach(x=>fixedSum+=monthlyReal(x));

    let cardTotal=0, cardMin=0;
    STATE.items.filter(x=>x.active && x.type==="card" && x.currency===cur)
      .forEach(x=>{
        const v=STATE.cardsMonth?.[x.id]||{};
        cardTotal += Number(v.amount||0);
        cardMin += Number(v.min_payment||0);
      });

    const total = fixedSum + cardTotal;
    const pay = fixedSum + cardMin;

    if(!total && !pay) return;

    const maxVal = cur==="IDR" ? 10000 : 8000;
    const pctTotal = Math.min((total/maxVal)*100, 100);
    const pctPay = Math.min((pay/maxVal)*100, 100);

    c.innerHTML += `
      <div class="chart-row">
        <div class="bar-label"><span><strong>${cur}</strong> (TOTAL)</span><span>${total.toFixed(2)}</span></div>
        <div class="bar-bg"><div class="bar-fill" style="width:${pctTotal}%"></div></div>
      </div>
      <div class="chart-row">
        <div class="bar-label"><span><strong>${cur}</strong> (A PAGAR)</span><span>${pay.toFixed(2)}</span></div>
        <div class="bar-bg"><div class="bar-fill" style="width:${pctPay}%"></div></div>
      </div>
    `;
  });

  if(!c.innerHTML.trim()) c.innerHTML=`<p class="muted">Sin datos para este mes.</p>`;
}

/* ================= RENDER: PAY CALENDAR ================= */
function buildPayItems(ym){
  const items=[];

  // fixed occurrences
  STATE.items.filter(x=>x.active && x.type==="fixed").forEach(it=>{
    const occ=occursInMonth(it, ym);
    if(!occ.occurs) return;
    items.push({
      key: it.id,
      date: occ.date,
      concept: it.name,
      meta: it.category + (it.notes ? " — "+it.notes : ""),
      currency: it.currency,
      amount: Number(it.amount_default||0),
      paid: !!STATE.paid[it.id],
    });
  });

  // cards occurrences (as min_payment)
  STATE.items.filter(x=>x.active && x.type==="card").forEach(it=>{
    const occ=occursInMonth(it, ym); // aquí schedule mensual day para tarjeta
    if(!occ.occurs) return;
    const v=STATE.cardsMonth?.[it.id]||{};
    items.push({
      key: it.id,
      date: occ.date,
      concept: `Tarjeta ${it.name} (mínimo)`,
      meta: "Tarjetas",
      currency: it.currency,
      amount: Number(v.min_payment||0),
      paid: !!STATE.paid[it.id],
    });
  });

  items.sort((a,b)=>a.date-b.date);
  return items;
}

function renderPayCalendar(){
  const ym = STATE.month;
  const tb=document.getElementById("payTableBody");
  tb.innerHTML="";

  const items=buildPayItems(ym);
  if(!items.length){
    tb.innerHTML=`<tr><td colspan="4" class="muted">Sin pagos en este mes.</td></tr>`;
    return;
  }

  items.forEach(it=>{
    const amountText=`${it.currency} ${Number(it.amount||0).toFixed(2)}`;
    tb.innerHTML += `
      <tr class="${it.paid ? "row-ok":""}">
        <td>${prettyDate(it.date)}</td>
        <td><strong>${it.concept}</strong><br><span class="muted">${it.meta}</span></td>
        <td class="right">${amountText}</td>
        <td class="right">
          <input type="checkbox" style="width:auto; transform:scale(1.2); margin:0;"
            data-paycheck="${it.key}" ${it.paid?"checked":""}>
        </td>
      </tr>
    `;
  });

  document.querySelectorAll("input[data-paycheck]").forEach(ch=>{
    ch.addEventListener("change", async ()=>{
      try{
        const item_id=ch.dataset.paycheck;
        const paid=!!ch.checked;
        // update UI optimista
        STATE.paid[item_id]=paid;
        renderPayCalendar();
        await apiCall("paid_set", STATE.month, { item_id, paid });
      }catch(e){
        setStatus(e.message);
      }
    });
  });
}

/* ================= ITEMS EDITOR (CRUD) ================= */
function renderItemsEditor(){
  const w=document.getElementById("itemsEditor");
  w.innerHTML="";

  const items=[...STATE.items].sort((a,b)=> (a.sort-b.sort) || (a.created_at>b.created_at?1:-1));

  if(!items.length){
    w.innerHTML=`<p class="muted">Aún no hay items. Usa los botones de añadir.</p>`;
    return;
  }

  // agrupamos por type
  const groups = [
    { title:"Pagos recurrentes", type:"fixed" },
    { title:"Tarjetas", type:"card" }
  ];

  groups.forEach(g=>{
    w.innerHTML += `<div class="row-head"><strong>${g.title}</strong></div>`;
    items.filter(x=>x.type===g.type).forEach(it=>{
      const st=it.schedule_type;
      const freqLabel = st==="monthly" ? "Mensual" : (st==="every_n_months" ? `Cada ${it.schedule_interval_months} meses` : `Cada ${it.schedule_interval_years} año(s)`);

      w.innerHTML += `
        <div class="card-item">
          <div class="mini">
            <span class="pill">${freqLabel}</span>
            <span class="pill">${it.currency}</span>
            ${it.active ? "" : `<span class="pill">INACTIVO</span>`}
            <strong>${it.name}</strong>
          </div>

          <div class="grid">
            <div>
              <div class="mini"><strong>Nombre</strong></div>
              <input data-it-name="${it.id}" value="${it.name}">
            </div>
            <div>
              <div class="mini"><strong>Categoría</strong></div>
              <input data-it-cat="${it.id}" value="${it.category||""}">
            </div>
          </div>

          <div class="grid">
            <div>
              <div class="mini"><strong>Moneda</strong></div>
              <select data-it-cur="${it.id}">
                ${["AED","EUR","IDR","USD"].map(c=>`<option value="${c}" ${c===it.currency?"selected":""}>${c}</option>`).join("")}
              </select>
            </div>
            <div>
              <div class="mini"><strong>Importe (solo fixed)</strong></div>
              <input type="number" step="0.01" data-it-amt="${it.id}" value="${it.amount_default ?? ""}" ${it.type==="card"?"disabled":""}>
            </div>
          </div>

          <div class="grid">
            <div>
              <div class="mini"><strong>Frecuencia</strong></div>
              <select data-it-st="${it.id}">
                <option value="monthly" ${st==="monthly"?"selected":""}>Mensual (día del mes)</option>
                <option value="every_n_months" ${st==="every_n_months"?"selected":""}>Cada N meses (próxima fecha)</option>
                <option value="every_n_years" ${st==="every_n_years"?"selected":""}>Cada N años (próxima fecha)</option>
              </select>
            </div>
            <div>
              <div class="mini"><strong>Notas</strong></div>
              <input data-it-notes="${it.id}" value="${it.notes||""}">
            </div>
          </div>

          <div class="grid">
            <div>
              <div class="mini"><strong>Día (mensual)</strong></div>
              <input type="number" min="1" max="31" data-it-day="${it.id}" value="${it.schedule_day ?? ""}" ${st==="monthly"?"":"disabled"}>
            </div>
            <div>
              <div class="mini"><strong>Próxima fecha</strong></div>
              <input type="date" data-it-next="${it.id}" value="${it.schedule_next ?? ""}" ${st==="monthly"?"disabled":""}>
            </div>
          </div>

          <div class="grid">
            <div>
              <div class="mini"><strong>N (meses)</strong></div>
              <input type="number" min="1" max="60" data-it-nm="${it.id}" value="${it.schedule_interval_months ?? ""}" ${st==="every_n_months"?"":"disabled"}>
            </div>
            <div>
              <div class="mini"><strong>N (años)</strong></div>
              <input type="number" min="1" max="10" data-it-ny="${it.id}" value="${it.schedule_interval_years ?? ""}" ${st==="every_n_years"?"":"disabled"}>
            </div>
          </div>

          <div class="grid">
            <button class="alt small-btn" data-it-toggle="${it.id}">${it.active ? "DESACTIVAR" : "ACTIVAR"}</button>
            <button class="danger small-btn" data-it-del="${it.id}">ELIMINAR</button>
          </div>
        </div>
      `;
    });
  });

  // autosave (debounce por item)
  const timers = new Map();
  function scheduleSave(id){
    if(timers.has(id)) clearTimeout(timers.get(id));
    timers.set(id, setTimeout(()=>saveItem(id), 450));
  }

  function readItemFromUI(id){
    const get = (sel)=>document.querySelector(sel);
    const it = STATE.items.find(x=>x.id===id);
    if(!it) return null;

    const schedule_type = get(`select[data-it-st="${id}"]`).value;

    return {
      ...it,
      name: get(`input[data-it-name="${id}"]`).value.trim(),
      category: get(`input[data-it-cat="${id}"]`).value.trim(),
      currency: get(`select[data-it-cur="${id}"]`).value,
      amount_default: it.type==="fixed" ? (Number(get(`input[data-it-amt="${id}"]`).value)||0) : null,
      notes: get(`input[data-it-notes="${id}"]`).value.trim() || null,
      schedule_type,
      schedule_day: schedule_type==="monthly" ? (Number(get(`input[data-it-day="${id}"]`).value)||1) : null,
      schedule_next: schedule_type!=="monthly" ? (get(`input[data-it-next="${id}"]`).value || null) : null,
      schedule_interval_months: schedule_type==="every_n_months" ? (Number(get(`input[data-it-nm="${id}"]`).value)||1) : null,
      schedule_interval_years: schedule_type==="every_n_years" ? (Number(get(`input[data-it-ny="${id}"]`).value)||1) : null,
    };
  }

  async function saveItem(id){
    try{
      const item = readItemFromUI(id);
      if(!item) return;

      // validación simple front
      if(!item.name) return setStatus("Nombre requerido");
      if(item.schedule_type==="monthly"){
        const d=Number(item.schedule_day);
        if(!d || d<1 || d>31) return setStatus("Día mensual inválido");
      }else{
        if(!item.schedule_next) return setStatus("Pon la próxima fecha");
      }

      setStatus("Guardando…");
      const saved = await apiCall("item_upsert", null, { item });
      // refresca item en memoria
      STATE.items = STATE.items.map(x=>x.id===saved.id ? saved : x);
      setStatus("Guardado ✅");
      // refresca vistas dependientes
      renderCardsMonth();
      renderCharts();
      renderPayCalendar();
    }catch(e){
      setStatus(e.message);
    }
  }

  // listeners inputs/selects
  w.querySelectorAll("input,select").forEach(el=>{
    const id =
      el.getAttribute("data-it-name") || el.getAttribute("data-it-cat") ||
      el.getAttribute("data-it-cur") || el.getAttribute("data-it-amt") ||
      el.getAttribute("data-it-st") || el.getAttribute("data-it-notes") ||
      el.getAttribute("data-it-day") || el.getAttribute("data-it-next") ||
      el.getAttribute("data-it-nm") || el.getAttribute("data-it-ny");

    if(!id) return;
    el.addEventListener("change", ()=>{
      // habilitar/deshabilitar inputs según schedule_type
      if(el.matches(`select[data-it-st="${id}"]`)){
        renderItemsEditor(); // re-render para toggles disabled/enabled, y reengancha listeners
        renderCharts();
        renderPayCalendar();
        return;
      }
      scheduleSave(id);
      // visual updates rápidos
      renderCharts();
      renderPayCalendar();
    });
  });

  // toggle active / delete
  w.querySelectorAll("button[data-it-toggle]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      try{
        const id=btn.dataset.itToggle;
        const it=STATE.items.find(x=>x.id===id);
        if(!it) return;
        const saved = await apiCall("item_upsert", null, { item: { ...it, active: !it.active }});
        STATE.items = STATE.items.map(x=>x.id===saved.id ? saved : x);
        renderItemsEditor();
        renderCardsMonth();
        renderCharts();
        renderPayCalendar();
        setStatus("OK ✅");
      }catch(e){ setStatus(e.message); }
    });
  });

  w.querySelectorAll("button[data-it-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      try{
        const id=btn.dataset.itDel;
        // delete en supabase (cascada borra paid)
        await apiCall("item_delete", null, { id });

        // también limpia cardsMonth si era tarjeta
        const nextCards = structuredClone(STATE.cardsMonth||{});
        delete nextCards[id];

        // actualiza en DB el mes para quitar esa tarjeta del JSON (si existía)
        STATE.cardsMonth = nextCards;
        await apiCall("set", STATE.month, { cards: nextCards });

        // recarga todo
        await autoLoad();
        setStatus("Eliminado ✅");
      }catch(e){ setStatus(e.message); }
    });
  });
}

/* ================= ADD NEW ITEM ================= */
async function addItem(type){
  try{
    setStatus("Creando…");
    const base = {
      type,
      category: type==="fixed" ? "Suscripciones" : "Tarjetas",
      name: type==="fixed" ? "Nuevo pago" : "Nueva tarjeta",
      currency: "AED",
      amount_default: type==="fixed" ? 0 : null,
      notes: null,
      schedule_type: "monthly",
      schedule_day: 1,
      schedule_next: null,
      schedule_interval_months: null,
      schedule_interval_years: null,
      active: true,
      sort: 1000
    };
    const saved = await apiCall("item_upsert", null, { item: base });
    // recarga
    await autoLoad();
    // scroll visual: no hace falta
    setStatus("Creado ✅ (edítalo abajo)");
  }catch(e){ setStatus(e.message); }
}

/* ================= AUTO LOAD ================= */
async function autoLoad(){
  try{
    STATE.month = currentMonthISO();
    setStatus("Cargando…");

    const payload = await apiCall("get", STATE.month);

    STATE.cardsMonth = payload.cards || {};
    STATE.items = payload.items || [];

    // paid array -> map
    const map = {};
    (payload.paid || []).forEach(x=>{ map[x.item_id] = !!x.paid; });
    STATE.paid = map;

    renderCardsMonth();
    renderItemsEditor();
    renderCharts();
    renderPayCalendar();

    setStatus("Actualizado ✅");
  }catch(e){
    setStatus(e.message);
    // limpia UI, pero no borra nada
    STATE.items=[];
    STATE.cardsMonth={};
    STATE.paid={};
    document.getElementById("cardsForm").innerHTML="";
    document.getElementById("itemsEditor").innerHTML="";
    document.getElementById("chartsContainer").innerHTML=`<p class="muted">Sin datos.</p>`;
    document.getElementById("payTableBody").innerHTML=`<tr><td colspan="4" class="muted">—</td></tr>`;
  }
}

/* ================= INIT ================= */
(function(){
  const now=new Date();
  const ms=document.getElementById("monthSelect");
  const ys=document.getElementById("yearSelect");

  ["01","02","03","04","05","06","07","08","09","10","11","12"]
    .forEach((m,i)=>ms.innerHTML+=`<option value="${m}">${i+1}</option>`);

  const y=now.getFullYear();
  for(let i=y-2;i<=y+2;i++) ys.innerHTML+=`<option value="${i}">${i}</option>`;

  ms.value=String(now.getMonth()+1).padStart(2,"0");
  ys.value=y;

  const p=localStorage.getItem(PIN_KEY);
  document.getElementById("pinHint").textContent=p?"PIN guardado ✅":"Introduce el PIN";
  if(p) autoLoad();
  else setStatus("Introduce el PIN y pulsa OK.");
})();

document.getElementById("savePin").onclick=()=>{
  const p=document.getElementById("pinInput").value.trim();
  if(p.length<6) return setStatus("PIN inválido");
  localStorage.setItem(PIN_KEY,p);
  document.getElementById("pinInput").value="";
  document.getElementById("pinHint").textContent="PIN guardado ✅";
  autoLoad();
};

document.getElementById("monthSelect").onchange=autoLoad;
document.getElementById("yearSelect").onchange=autoLoad;

document.getElementById("syncNow").onclick=async()=>{
  try{
    setStatus("Sincronizando…");
    const cards = collectCardsMonth();
    await apiCall("set", STATE.month, { cards });
    await autoLoad();
    setStatus("Sincronizado ✅");
  }catch(e){ setStatus(e.message); }
};

document.getElementById("addFixed").onclick=()=>addItem("fixed");
document.getElementById("addCard").onclick=()=>addItem("card");
</script>
</body>
</html>
