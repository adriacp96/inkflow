<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas</title>
  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 16px; max-width: 980px; }
    .card { border: 1px solid #e9e9e9; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; }
    .row4 { display:grid; grid-template-columns: 1fr 150px 120px 120px; gap: 10px; align-items:end; }
    label { font-size: 12px; color: #666; display:block; margin-bottom: 6px; }
    input, select, button, textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d9d9d9; }
    button { cursor: pointer; }
    .btn { background:#111; color:#fff; border:1px solid #111; }
    .btn2 { background:#fff; color:#111; }
    .muted { color:#666; font-size: 13px; }
    .ok { color:#166534; }
    .bad { color:#991b1b; }
    .pillwrap { display:flex; flex-wrap:wrap; gap:10px; }
    .pill { border:1px solid #eee; border-radius:999px; padding:8px 12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #eee; font-size: 14px; }
    th { font-size: 12px; color:#666; font-weight:600; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <h1>Finanzas</h1>
  <p class="muted">Sin app. Sin login. Sincroniza en la nube con un PIN (se guarda en cada dispositivo).</p>

  <div class="card">
    <h2 style="margin:0 0 10px;">PIN</h2>
    <div class="row">
      <div>
        <label>PIN (mínimo 6; recomendado 10+)</label>
        <input id="pinInput" type="password" placeholder="Se guardará en este dispositivo" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn2" id="savePin">Guardar PIN</button>
      </div>
    </div>
    <p id="pinStatus" class="muted"></p>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Mes</h2>
    <div class="row">
      <div>
        <label>Selecciona mes</label>
        <input id="month" type="month" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="loadMonth">Cargar mes</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Tarjetas (solo esto cambia cada mes)</h2>
    <div id="cardsForm"></div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="btn" id="saveCards">Guardar en la nube</button>
      <button class="btn2" id="resetCards">Reset del mes</button>
    </div>
    <p id="status" class="muted"></p>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Totales</h2>
    <div class="pillwrap" id="totals"></div>
    <p class="muted">Nota: no convierto monedas automáticamente.</p>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Gastos fijos (precargados)</h2>
    <table>
      <thead>
        <tr>
          <th>Concepto</th><th>Categoría</th><th>Frecuencia</th><th class="right">Importe</th><th>Moneda</th><th class="right">Mensual real</th>
        </tr>
      </thead>
      <tbody id="fixedTable"></tbody>
    </table>
  </div>

<script>
/** ====== CONFIG: PEGA AQUÍ TUS DATOS DE SUPABASE ======
 * Supabase → Project Settings → API
 * - Project URL
 * - anon public key
 */
const SUPABASE_URL = "https://wogqftmhwgosoaldwees.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvZ3FmdG1od2dvc29hbGR3ZWVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODE2MjUsImV4cCI6MjA4NTE1NzYyNX0.lJw1YPSOiV-RJBrhX7aNpJiwUwGjes6cNxTfg5CEg38";

/** ====== Datos fijos ====== */
const FIXED = [
  { concept:"Apple One", category:"Suscripción", freq:"Mensual", amount:97.95, currency:"AED" },
  { concept:"Netflix", category:"Suscripción", freq:"Mensual", amount:9.99, currency:"EUR" },
  { concept:"Real Debrid", category:"Suscripción", freq:"Semestral", amount:16, currency:"EUR" },
  { concept:"Formula 1", category:"Suscripción", freq:"Anual", amount:3649, currency:"IDR" },
  { concept:"YouTube Premium", category:"Suscripción", freq:"Mensual", amount:195, currency:"IDR" },
  { concept:"Du", category:"Telefonía", freq:"Mensual", amount:252, currency:"AED" },
  { concept:"Virgin", category:"Telefonía", freq:"Anual", amount:1575, currency:"AED" },
  { concept:"Emirates Islamic", category:"Préstamo", freq:"Mensual", amount:1739, currency:"AED" },
  { concept:"Emirates NBD", category:"Préstamo", freq:"Mensual", amount:3346, currency:"AED" },
  { concept:"Seguro coche", category:"Seguro / Carné", freq:"Anual", amount:3003, currency:"AED" },
  { concept:"Carné conducir", category:"Seguro / Carné", freq:"Trienal", amount:320, currency:"AED" }
];

const CARDS = [
  { name:"Emirates NBD", currency:"AED" },
  { name:"Tabby", currency:"AED" },
  { name:"Amex", currency:"EUR" }
];

function monthlyReal(item){
  if(item.freq === "Mensual") return item.amount;
  if(item.freq === "Anual") return item.amount/12;
  if(item.freq === "Semestral") return item.amount/6;
  if(item.freq === "Trienal") return item.amount/36;
  return 0;
}

function defaultMonth(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

function fmt(n, c){
  if(typeof n !== "number" || isNaN(n)) n = 0;
  try { return new Intl.NumberFormat("es-ES", { style:"currency", currency: c }).format(n); }
  catch { return `${n.toFixed(2)} ${c}`; }
}

/** ====== PIN (se guarda en el dispositivo) ====== */
const PIN_KEY = "fin_pin_v1";
function getPin(){ return localStorage.getItem(PIN_KEY) || ""; }
function setPin(p){ localStorage.setItem(PIN_KEY, p); }

function ensurePin(){
  const p = getPin();
  if(!p) throw new Error("No hay PIN guardado. Escríbelo y pulsa Guardar PIN.");
  if(p.length < 6) throw new Error("PIN demasiado corto (mínimo 6).");
  return p;
}

/** ====== Llamadas a Edge Function ====== */
function functionUrl(){
  return `${SUPABASE_URL.replace(/\/$/,"")}/functions/v1/finanzas`;
}

async function apiCall(action, month, data=null){
  const pin = ensurePin();
  const res = await fetch(functionUrl(), {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "apikey": SUPABASE_ANON_KEY
    },
    body: JSON.stringify({ action, pin, month, data })
  });

  const text = await res.text();
  let json = null;
  try { json = JSON.parse(text); } catch {}

  if(!res.ok){
    const msg = (json && json.error) ? json.error : text || "Error desconocido";
    throw new Error(msg);
  }
  return json;
}

/** ====== Render fijo ====== */
function renderFixed(){
  const tbody = document.getElementById("fixedTable");
  tbody.innerHTML = "";
  for(const f of FIXED){
    const m = monthlyReal(f);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.concept}</td>
      <td>${f.category}</td>
      <td>${f.freq}</td>
      <td class="right">${f.currency==="IDR" ? f.amount.toFixed(0) : f.amount.toFixed(2)}</td>
      <td>${f.currency}</td>
      <td class="right">${f.currency==="IDR" ? m.toFixed(0)+" "+f.currency : fmt(m,f.currency)}</td>
    `;
    tbody.appendChild(tr);
  }
}

/** ====== Tarjetas ====== */
function renderCardsForm(prefill){
  const wrap = document.getElementById("cardsForm");
  wrap.innerHTML = "";

  for(const c of CARDS){
    const amount = prefill?.cards?.[c.name]?.amount ?? "";
    const paid = prefill?.cards?.[c.name]?.paid ? "si" : "no";

    const row = document.createElement("div");
    row.className = "row4";
    row.style.marginBottom = "10px";
    row.innerHTML = `
      <div>
        <label>Tarjeta</label>
        <input value="${c.name}" disabled />
      </div>
      <div>
        <label>Importe</label>
        <input inputmode="decimal" placeholder="0" data-card="${c.name}" value="${amount}" />
      </div>
      <div>
        <label>Moneda</label>
        <input value="${c.currency}" disabled />
      </div>
      <div>
        <label>Pagado</label>
        <select data-paid="${c.name}">
          <option value="no">No</option>
          <option value="si">Sí</option>
        </select>
      </div>
    `;
    wrap.appendChild(row);
    row.querySelector(`select[data-paid="${c.name}"]`).value = paid;
  }
}

function collectCards(){
  const cards = {};
  document.querySelectorAll("input[data-card]").forEach(inp=>{
    const name = inp.getAttribute("data-card");
    const num = Number(String(inp.value).replace(",", "."));
    cards[name] = cards[name] || {};
    cards[name].amount = isNaN(num) ? 0 : num;
  });
  document.querySelectorAll("select[data-paid]").forEach(sel=>{
    const name = sel.getAttribute("data-paid");
    cards[name] = cards[name] || {};
    cards[name].paid = sel.value === "si";
  });
  return cards;
}

function renderTotals(cards){
  const totalsDiv = document.getElementById("totals");
  totalsDiv.innerHTML = "";

  const fixedBy = {};
  for(const f of FIXED){
    const m = monthlyReal(f);
    fixedBy[f.currency] = (fixedBy[f.currency] || 0) + m;
  }

  const cardsBy = {};
  for(const c of CARDS){
    const a = Number(cards?.[c.name]?.amount || 0);
    cardsBy[c.currency] = (cardsBy[c.currency] || 0) + a;
  }

  const currencies = new Set([...Object.keys(fixedBy), ...Object.keys(cardsBy)]);
  for(const cur of currencies){
    const fixed = fixedBy[cur] || 0;
    const card = cardsBy[cur] || 0;
    const total = fixed + card;

    const pill = document.createElement("div");
    pill.className = "pill";
    pill.innerHTML = `
      <div><strong>${cur}</strong></div>
      <div class="muted">Fijos (mensual real): ${cur==="IDR" ? fixed.toFixed(0)+" "+cur : fmt(fixed,cur)}</div>
      <div class="muted">Tarjetas (mes): ${cur==="IDR" ? card.toFixed(0)+" "+cur : fmt(card,cur)}</div>
      <div style="margin-top:6px;"><strong>Total:</strong> ${cur==="IDR" ? total.toFixed(0)+" "+cur : fmt(total,cur)}</div>
    `;
    totalsDiv.appendChild(pill);
  }
}

/** ====== UI ====== */
const monthInput = document.getElementById("month");
monthInput.value = defaultMonth();

function setStatus(msg, ok=true){
  const el = document.getElementById("status");
  el.textContent = msg;
  el.className = ok ? "muted ok" : "muted bad";
}

document.getElementById("savePin").addEventListener("click", () => {
  const p = (document.getElementById("pinInput").value || "").trim();
  if(p.length < 6) { document.getElementById("pinStatus").textContent = "PIN demasiado corto (mínimo 6)."; return; }
  setPin(p);
  document.getElementById("pinInput").value = "";
  document.getElementById("pinStatus").textContent = "PIN guardado en este dispositivo ✅";
});

document.getElementById("loadMonth").addEventListener("click", async () => {
  const m = monthInput.value || defaultMonth();
  setStatus("Cargando...", true);
  try{
    const res = await apiCall("get", m, null);
    const data = res?.data || { month: m, cards: {} };
    renderCardsForm(data);
    renderTotals(data.cards || {});
    setStatus("Mes cargado ✅", true);
  }catch(e){
    renderCardsForm({ month: m, cards: {} });
    renderTotals({});
    setStatus("No se pudo cargar (o no hay datos). Error: " + e.message, false);
  }
});

document.getElementById("saveCards").addEventListener("click", async () => {
  const m = monthInput.value || defaultMonth();
  setStatus("Guardando...", true);
  try{
    const cards = collectCards();
    await apiCall("set", m, { month: m, cards });
    renderTotals(cards);
    setStatus("Guardado en la nube ✅", true);
  }catch(e){
    setStatus("Error al guardar: " + e.message, false);
  }
});

document.getElementById("resetCards").addEventListener("click", () => {
  renderCardsForm({ month: monthInput.value || defaultMonth(), cards: {} });
  renderTotals({});
  setStatus("Reset hecho (no guardado).", true);
});

/** Init */
renderFixed();
renderCardsForm({ month: monthInput.value, cards: {} });
renderTotals({});
const existingPin = getPin();
document.getElementById("pinStatus").textContent = existingPin ? "Este dispositivo ya tiene un PIN guardado ✅" : "No hay PIN guardado aún.";
</script>
</body>
</html>
