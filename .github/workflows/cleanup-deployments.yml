name: Clean up old deployments

on:
  workflow_dispatch:  # Allow manual triggering

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      deployments: write
      
    steps:
      - name: Clean up old deployments
        uses: actions/github-script@v7
        with:
          script: |
            const deployments = await github.paginate(github.rest.repos.listDeployments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            console.log(`Found ${deployments.length} total deployments`);
            
            if (deployments.length <= 1) {
              console.log('Only 1 or fewer deployments found. Nothing to delete.');
              return;
            }
            
            // Sort by created_at descending to keep the most recent
            deployments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Keep only the first (most recent) deployment
            const toKeep = deployments[0];
            const toDelete = deployments.slice(1);
            
            console.log(`Keeping deployment: ${toKeep.id} (environment: ${toKeep.environment}, created: ${toKeep.created_at})`);
            console.log(`Note: This will delete deployments across all environments.`);
            console.log(`Deleting ${toDelete.length} old deployments...`);
            
            let deletedCount = 0;
            let failedCount = 0;
            
            for (const deployment of toDelete) {
              try {
                // First, set deployment status to inactive
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                  state: 'inactive'
                });
                
                // Then delete the deployment
                await github.rest.repos.deleteDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
                
                console.log(`Deleted deployment ${deployment.id} (environment: ${deployment.environment})`);
                deletedCount++;
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 500));
              } catch (error) {
                console.error(`Failed to delete deployment ${deployment.id}: ${error.message}`);
                const status = error.status || error.response?.status;
                if (status) {
                  console.error(`  Status: ${status}`);
                }
                failedCount++;
              }
            }
            
            console.log(`Cleanup completed: ${deletedCount} deleted, ${failedCount} failed`);
            
            if (failedCount > 0) {
              throw new Error(`Failed to delete ${failedCount} deployment(s)`);
            }
