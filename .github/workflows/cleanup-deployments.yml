name: Clean up old deployments

on:
  workflow_dispatch:  # Allow manual triggering

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      deployments: write
      
    steps:
      - name: Clean up old deployments
        uses: actions/github-script@v7
        with:
          script: |
            const deployments = await github.paginate(github.rest.repos.listDeployments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            console.log(`Found ${deployments.length} total deployments`);
            
            if (deployments.length <= 1) {
              console.log('Only 1 or fewer deployments found. Nothing to delete.');
              return;
            }
            
            // Sort by created_at descending to keep the most recent
            deployments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Keep only the first (most recent) deployment
            const toKeep = deployments[0];
            const toDelete = deployments.slice(1);
            
            console.log(`Keeping deployment: ${toKeep.id} (${toKeep.environment}, created: ${toKeep.created_at})`);
            console.log(`Deleting ${toDelete.length} old deployments...`);
            
            for (const deployment of toDelete) {
              try {
                // First, set deployment status to inactive
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                  state: 'inactive'
                });
                
                // Then delete the deployment
                await github.rest.repos.deleteDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
                
                console.log(`Deleted deployment ${deployment.id} (${deployment.environment})`);
              } catch (error) {
                console.error(`Failed to delete deployment ${deployment.id}: ${error.message}`);
              }
            }
            
            console.log('Cleanup completed!');
